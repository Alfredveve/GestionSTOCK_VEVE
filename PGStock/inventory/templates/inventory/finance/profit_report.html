{% extends 'inventory/base.html' %}
{% load static humanize permission_tags %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body py-4">
                <form method="get" class="d-flex align-items-end flex-wrap gap-3">
                    <div class="flex-grow-1">
                        <h3 class="fw-bold mb-1 d-flex align-items-center">
                            <i class="fas fa-chart-line me-2 text-success"></i>Rapport de Bénéfice & Intérêt Net
                        </h3>
                        <p class="text-muted mb-0 small">Analyse financière mensuelle par point de vente</p>
                    </div>
                    
                    <div>
                        <label class="form-label small fw-bold text-muted">Mois</label>
                        <select name="month" class="form-select form-select-sm" style="min-width: 150px;">
                            {% for num, name in months %}
                                <option value="{{ num }}" {% if num == month %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="form-label small fw-bold text-muted">Année</label>
                        <select name="year" class="form-select form-select-sm" style="min-width: 200px;">
                            {% for y in years %}
                                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm px-4">
                        <i class="fas fa-filter me-2"></i>Filtrer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Global Summary Cards -->
<div class="row mb-5 g-4">
    <div class="col-md-6 col-lg-3">
        <div class="card bg-primary text-white h-100 border-0 shadow-sm position-relative overflow-hidden">
            <div class="position-absolute top-0 end-0 opacity-10 mt-2 me-2">
                <i class="fas fa-shopping-cart fa-4x"></i>
            </div>
            <div class="card-body">
                <h6 class="text-white-50 text-uppercase fw-bold mb-2 small">Ventes Brutes</h6>
                <div class="d-flex align-items-baseline">
                    <h2 class="mb-0 fw-bold">{{ global_sales|mask_currency:user }}</h2>
                    <small class="ms-2 opacity-75"></small>
                </div>
                <div class="mt-2 text-white-50 small">
                    Avant remises
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card bg-info text-white h-100 border-0 shadow-sm position-relative overflow-hidden">
            <div class="position-absolute top-0 end-0 opacity-10 mt-2 me-2">
                <i class="fas fa-percent fa-4x"></i>
            </div>
            <div class="card-body">
                <h6 class="text-white-50 text-uppercase fw-bold mb-2 small">Ventes Nettes</h6>
                <div class="d-flex align-items-baseline">
                    <h2 class="mb-0 fw-bold">{{ global_net_sales|mask_currency:user }}</h2>
                    <small class="ms-2 opacity-75"></small>
                </div>
                <div class="mt-2 text-white-50 small">
                    Après remises
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card bg-success text-white h-100 border-0 shadow-sm position-relative overflow-hidden">
            <div class="position-absolute top-0 end-0 opacity-10 mt-2 me-2">
                <i class="fas fa-coins fa-4x"></i>
            </div>
            <div class="card-body">
                <h6 class="text-white-50 text-uppercase fw-bold mb-2 small">Intérêt Net Global</h6>
                <div class="d-flex align-items-baseline">
                    <h2 class="mb-0 fw-bold">{{ global_profit|mask_currency:user }}</h2>
                    <small class="ms-2 opacity-75"></small>
                </div>
                <div class="mt-2 text-white-50 small">
                    Bénéfice Réel (Marge - Dépenses)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="card-title fw-bold text-dark mb-0">Évolution Mensuelle ({{ year }})</h5>
            </div>
            <div class="card-body">
                <canvas id="profitChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('profitChart').getContext('2d');
        const profitChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
                datasets: [
                    {
                        label: 'Marge Brute',
                        data: {{ chart_gross_profits|safe }},
                        borderColor: '#009ef7', /* Primary Blue */
                        backgroundColor: 'rgba(0, 158, 247, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Intérêt Net',
                        data: {{ chart_net_interests|safe }},
                        borderColor: '#50cd89', /* Success Green */
                        backgroundColor: 'rgba(80, 205, 137, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('fr-GN').format(context.parsed.y) + ' GNF';
                                }
                                return label;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: {{ month }} - 1,
                                xMax: {{ month }} - 1,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return new Intl.NumberFormat('fr-GN', { notation: "compact" }).format(value) + ' GNF';
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: function(context) {
                            var index = context.dataIndex;
                            var selectedMonthIndex = {{ month }} - 1;
                            return index === selectedMonthIndex ? 8 : 3;
                        },
                        backgroundColor: function(context) {
                            var index = context.dataIndex;
                            var selectedMonthIndex = {{ month }} - 1;
                            return index === selectedMonthIndex ? '#ffc107' : context.dataset.backgroundColor; // Highlight color
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    });
</script>

<!-- Detailed Table -->
<div class="card shadow-sm border-0 mb-5">
    <div class="card-header bg-white py-3">
        <h5 class="card-title fw-bold text-dark mb-0">Détail par Point de Vente</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-uppercase text-muted fs-7 fw-bold">
                    <tr>
                        <th class="ps-4">Point de Vente</th>
                        <th class="text-end text-primary">Ventes Brutes</th>
                        <th class="text-end text-danger">Remises</th>
                        <th class="text-end text-secondary">Coût Achat</th>
                        <th class="text-end bg-light-primary fw-bold text-primary border-start border-end">Marge Brute</th>
                        <th class="text-end text-warning">Dépenses</th>
                        <th class="text-end pe-4 bg-light-success fw-bolder text-success">INTÉRÊT NET</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td class="ps-4 fw-bold text-dark">{{ report.point_of_sale.name }}</td>
                        <td class="text-end font-monospace">{{ report.total_sales_brut|mask_currency:user }}</td>
                        <td class="text-end font-monospace text-danger">-{{ report.total_discounts|mask_currency:user }}</td>
                        <td class="text-end font-monospace text-secondary">-{{ report.total_cost_of_goods|mask_currency:user }}</td>
                        <td class="text-end font-monospace bg-light-primary fw-bold text-primary border-start border-end">
                            {{ report.gross_profit|mask_currency:user }}
                        </td>
                        <td class="text-end font-monospace text-warning">-{{ report.total_expenses|mask_currency:user }}</td>
                        <td class="text-end pe-4 font-monospace bg-light-success fw-bolder text-success">
                            {{ report.net_interest|mask_currency:user }}
                        </td>
                    </tr>
                    {% empty %}

                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i>
                            <p class="mb-0">Aucune donnée trouvée.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

