{% extends 'inventory/base.html' %}
{% load static permission_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-4 d-flex justify-content-between align-items-center">
                <h3 class="card-title fw-bold mb-0 text-dark">
                    <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>Détails de la Dépense
                </h3>
                <div>
                    <a href="{% url 'inventory:expense_edit' expense.pk %}" class="btn btn-warning me-2">
                        <i class="fas fa-edit me-1"></i>Modifier
                    </a>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ expense.pk }}', '{{ expense.reference }}')">
                        <i class="fas fa-trash me-1"></i>Supprimer
                    </button>
                </div>
            </div>
            <div class="card-body p-5">
                <div class="row mb-5">
                    <div class="col-md-6 mb-4 mb-md-0">
                        <label class="text-uppercase text-muted fs-7 fw-bold mb-2 d-block">Référence</label>
                        <h4 class="fw-bold text-primary">{{ expense.reference }}</h4>
                    </div>
                    <div class="col-md-6">
                        <label class="text-uppercase text-muted fs-7 fw-bold mb-2 d-block">Date</label>
                        <h4 class="fw-bold">{{ expense.date|date:"d F Y" }}</h4>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-md-6 mb-4 mb-md-0">
                        <label class="text-uppercase text-muted fs-7 fw-bold mb-2 d-block">Catégorie</label>
                        <span class="badge bg-light-warning text-warning p-2 px-3 fs-6">{{ expense.category.name }}</span>
                    </div>
                    <div class="col-md-6">
                        <label class="text-uppercase text-muted fs-7 fw-bold mb-2 d-block">Point de Vente</label>
                        <span class="badge bg-light-info text-info p-2 px-3 fs-6">{{ expense.point_of_sale.name }}</span>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12">
                        <div class="bg-light p-4 rounded-3 d-flex justify-content-between align-items-center">
                            <label class="text-uppercase text-muted fs-7 fw-bold mb-0">Montant Total</label>
                            <h2 class="fw-bold mb-0 text-dark">{{ expense.amount|mask_currency:user }}</h2>
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="text-uppercase text-muted fs-7 fw-bold mb-2 d-block">Description / Notes</label>
                    <div class="p-3 bg-white border rounded">
                        {% if expense.description %}
                            {{ expense.description|linebreaks }}
                        {% else %}
                            <em class="text-muted">Aucune description fournie.</em>
                        {% endif %}
                    </div>
                </div>

                <div class="row pt-4 border-top">
                    <div class="col-md-6">
                        <small class="text-muted d-block">Enregistré par :</small>
                        <span class="fw-bold">{{ expense.created_by.get_full_name|default:expense.created_by.username }}</span>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small class="text-muted d-block">Date d'enregistrement :</small>
                        <span class="fw-bold">{{ expense.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-3 px-5">
                <a href="{% url 'inventory:expense_list' %}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression (réutilisé) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                </div>
                <p class="mb-0 fs-5">Êtes-vous sûr de vouloir supprimer la dépense <span id="deleteExpenseRef" class="fw-bold"></span> ?</p>
                <p class="text-muted small mt-2">Cette action est irréversible et le rapport financier sera recalculé.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger px-4">Supprimer définitivement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDelete(pk, reference) {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        document.getElementById('deleteExpenseRef').textContent = reference;
        document.getElementById('deleteForm').action = `/inventory/finance/expenses/${pk}/delete/`;
        modal.show();
    }
</script>
{% endblock %}
