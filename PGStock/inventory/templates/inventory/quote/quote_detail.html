{% extends 'inventory/base.html' %}
{% load inventory_extras %}
{% load static %}

{% block title %}Bon de Commande {{ quote.quote_number }}{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap');

    :root {
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --accent-gold: #b4945c;
    }

    .font-elegant {
        font-family: 'Playfair Display', serif;
    }

    .text-gradient {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
    }

    @media print {
        @page {
            size: A4;
            margin: 0mm;
        }

        html, body {
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
            height: auto !important;
        }

        .no-print {
            display: none !important;
        }

        .sheet {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 8mm 10mm !important; /* Tighter padding for print */
            box-shadow: none !important;
            border: none !important;
            min-height: auto !important;
            height: auto !important;
            page-break-after: avoid !important;
            overflow: visible !important;
            background: white !important;
        }

        .sheet::before {
            display: none !important;
        }

        header {
            margin-bottom: 3mm !important;
            padding-bottom: 2mm !important;
        }

        .table-responsive {
            overflow: visible !important;
        }
        
        .total-card {
            padding: 1rem !important;
        }
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        border: 1px solid var(--glass-border);
        color: #94a3b8;
        transition: all 0.3s ease;
        border-radius: 0.75rem;
    }

    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateY(-2px);
    }

    .btn-modern-primary {
        background: var(--primary-gradient);
        border: none;
        color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-modern-primary:hover {
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        transform: translateY(-2px);
        color: white;
    }

    .sheet {
        background: white;
        max-width: 210mm;
        margin: 1rem auto; /* Reduced external margin */
        padding: 15mm; /* Reduced internal padding */
        box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.6);
        border-radius: 0.25rem;
        position: relative;
        min-height: 200mm;
        color: #1a1a1a;
        overflow: hidden;
    }

    .sheet::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: radial-gradient(#f1f5f9 1px, transparent 1px);
        background-size: 20px 20px;
        opacity: 0.3;
        pointer-events: none;
    }

    .content-area {
        position: relative;
        z-index: 1;
    }

    .info-label {
        font-size: 0.65rem; /* Slightly smaller */
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--accent-gold);
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .currency-nowrap {
        white-space: nowrap;
    }

    .table thead th {
        background-color: #f8fafc;
        border-bottom: 1px solid #1a1a1a;
        color: #1a1a1a;
        font-size: 0.7rem; /* Smaller th */
        letter-spacing: 0.05em;
        padding: 0.5rem;
    }

    .table tbody td {
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.85rem; /* Slightly smaller text */
        padding: 0.5rem !important; /* Tighter rows */
    }

    .accent-border {
        border-left: 3px solid var(--accent-gold);
        padding-left: 1.25rem;
    }

    .total-card {
        background: #1a1a1a;
        color: white;
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .total-card .text-secondary {
        color: #94a3b8 !important;
    }

    .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 6rem; /* Smaller watermark */
        font-weight: 900;
        color: rgba(0,0,0,0.015);
        text-transform: uppercase;
        letter-spacing: 1rem;
        pointer-events: none;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="container d-flex justify-content-between align-items-center mb-4 no-print py-3">
    <a href="{% url 'inventory:quote_list' %}" class="btn btn-glass px-4 d-flex align-items-center gap-2">
        <i class="bi bi-arrow-left"></i> <span>RETOUR</span>
    </a>
    <div class="d-flex gap-3">
        <button onclick="window.print()" class="btn btn-glass px-4 d-flex align-items-center gap-2 text-white">
            <i class="bi bi-printer"></i> <span>IMPRIMER</span>
        </button>
        {% if quote.status != 'converted' %}
        <a href="{% url 'inventory:quote_update' quote.pk %}" class="btn btn-glass px-4 text-white">
            <i class="bi bi-pencil-square"></i> MODIFIER
        </a>
        <a href="{% url 'inventory:quote_add_item' quote.pk %}" class="btn btn-modern-primary px-4">
            <i class="bi bi-plus-circle"></i> AJOUTER ARTICLE
        </a>
        <a href="{% url 'inventory:quote_convert' quote.pk %}" class="btn btn-modern-primary px-4 bg-success" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <i class="bi bi-arrow-repeat"></i> CONVERTIR
        </a>
        {% endif %}
        <!-- DEBUG: Status is "{{ quote.status }}" -->
    </div>
</div>

<!-- Elegant Quote Sheet -->
<div class="sheet shadow-none">
    <div class="watermark">DEVIS</div>
    
    <div class="content-area">
        <!-- Elegant Header -->
        <header class="row mb-4 align-items-center">
            <div class="col-7">
                <div class="info-label mb-0">PROPOSITION COMMERCIALE</div>
                <h1 class="font-elegant fw-bold text-dark mb-0 fs-2" style="letter-spacing: -1px;">BON DE COMMANDE</h1>
                <p class="text-secondary font-monospace mb-0 mt-1 small">RÉFÉRENCE: {{ quote.quote_number }}</p>
            </div>
            <div class="col-5 text-end">
                <div class="d-inline-block text-end">
                    <div class="bg-dark text-white p-2 px-3 rounded-0 mb-2">
                        <h5 class="mb-0 font-elegant ls-1 fw-bold">GESTION STOCK</h5>
                    </div>
                    {% if quote.status == 'converted' %}
                    <span class="badge bg-success-subtle text-success border border-success px-2 py-1 rounded-pill small">
                        <i class="bi bi-check-circle-fill me-1"></i> DOCUMENT CONVERTI
                    </span>
                    {% endif %}
                </div>
            </div>
        </header>

        <div class="row mb-4 g-3">
            <!-- Client Info -->
            <div class="col-6">
                <div class="accent-border">
                    <div class="info-label">DESTINATAIRE</div>
                    <h2 class="font-elegant h5 fw-bold mb-1 text-dark text-uppercase">{{ quote.client.name }}</h2>
                    <div class="text-secondary small" style="line-height: 1.4; font-size: 0.8rem;">
                        {% if quote.client.address %}<div class="mb-0">{{ quote.client.address }}</div>{% endif %}
                        {% if quote.client.city %}<div class="mb-0">{{ quote.client.city }}</div>{% endif %}
                        {% if quote.client.phone %}<div class="mb-0"><i class="bi bi-telephone-fill me-2" style="font-size: 0.6rem;"></i>{{ quote.client.phone }}</div>{% endif %}
                        {% if quote.client.email %}<div class="mb-0"><i class="bi bi-envelope-fill me-2" style="font-size: 0.6rem;"></i>{{ quote.client.email }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Quote Info -->
            <div class="col-6 text-end">
                <div class="d-inline-block text-start p-2 px-3" style="border: 1px solid #f1f5f9; min-width: 180px;">
                    <div class="mb-2">
                        <div class="info-label">ÉMIS LE</div>
                        <div class="fw-bold font-monospace text-dark small">{{ quote.date_issued|date:'d F Y' }}</div>
                    </div>
                    <div class="mb-2">
                        <div class="info-label">VALIDE JUSQU'AU</div>
                        <div class="fw-bold font-monospace text-dark text-danger small">{{ quote.valid_until|date:'d F Y' }}</div>
                    </div>
                    <div class="mb-2">
                        <div class="info-label">STATUT</div>
                        <span class="fw-bold text-dark x-small" style="font-size: 0.7rem;">
                            <i class="bi bi-circle-fill me-1 text-{% if quote.status == 'pending' %}warning{% elif quote.status == 'accepted' %}success{% else %}secondary{% endif %}" style="font-size: 0.4rem;"></i>
                            {{ quote.get_status_display.upper }}
                        </span>
                    </div>
                    <div>
                        <div class="info-label">TYPE</div>
                        <span class="badge bg-light-warning text-warning border border-warning x-small px-2 py-0" style="font-size: 0.6rem;">
                            {{ quote.get_quote_type_display.upper }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Elegant Table -->
        <div class="mt-2">
            <table class="table table-borderless align-middle mb-0">
                <thead>
                    <tr class="text-uppercase">
                        <th class="ps-0" style="width: 40%">DÉSIGNATION</th>
                        <th class="text-center">GROS ?</th>
                        <th class="text-center">QTÉ</th>
                        <th class="text-end">UNITAIRE</th>
                        <th class="text-center">REMISE</th>
                        <th class="text-end pe-0">TOTAL HT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td class="ps-0 py-2">
                            <div class="fw-bold text-dark">{{ item.product.name }}</div>
                            <small class="text-muted font-monospace ls-1" style="font-size: 0.7rem;">{{ item.product.sku }}</small>
                        </td>
                        <td class="text-center">
                            {% if item.is_wholesale %}
                                <span class="badge bg-warning-subtle text-warning border border-warning px-1 py-0 x-small" style="font-size: 0.6rem;">OUI</span>
                            {% else %}
                                <span class="text-muted x-small" style="font-size: 0.6rem;">NON</span>
                            {% endif %}
                        </td>
                        <td class="text-center font-monospace">{{ item.quantity }}</td>
                        <td class="text-end font-monospace currency-nowrap">{{ item.unit_price|format_currency }}</td>
                        <td class="text-center font-monospace">{{ item.discount }}%</td>
                        <td class="text-end pe-0 font-monospace fw-bold text-dark currency-nowrap">{{ item.total|format_currency }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="py-4 text-center text-muted fst-italic">Aucune ligne de commande enregistrée.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if quote.notes %}
        <div class="mt-3 pt-2 mb-3" style="border-top: 1px dashed #e2e8f0;">
            <div class="info-label mb-1">NOTES</div>
            <p class="small text-secondary mb-0" style="white-space: pre-line; line-height: 1.4; font-style: italic; font-size: 0.75rem;">{{ quote.notes }}</p>
        </div>
        {% endif %}

        <!-- Summary Stats -->
        <div class="row justify-content-end mt-3">
            <div class="col-5">
                <div class="total-card shadow-lg p-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-secondary small text-uppercase x-small" style="font-size: 0.65rem;">TOTAL HORS TAXES</span>
                        <span class="fw-bold font-monospace small">{{ quote.subtotal|format_currency }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1 pb-1 border-bottom border-secondary">
                        <span class="text-secondary small text-uppercase x-small" style="font-size: 0.65rem;">TVA ({{ quote.tax_rate }}%)</span>
                        <span class="fw-bold font-monospace small">+ {{ quote.tax_amount|format_currency }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <span class="fw-bold text-uppercase x-small" style="color: var(--accent-gold); font-size: 0.65rem;">NET À PAYER</span>
                        <div class="text-end">
                            <span class="h6 fw-bold text-white mb-0 font-monospace currency-nowrap d-block">{{ quote.total_amount|format_currency }}</span>
                            <span class="text-secondary" style="font-size: 0.55rem;">GNF</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer / Signature -->
        <div class="mt-4 pt-3">
            <div class="row text-center">
                <div class="col-6 px-4">
                    <div class="info-label mb-4">ACCORD DU CLIENT</div>
                    <div class="border-bottom border-dark mx-auto" style="width: 80%; opacity: 0.1;"></div>
                    <small class="text-muted fst-italic mt-2 d-block x-small" style="font-size: 0.65rem;">Mention "Bon pour accord" + Signature</small>
                </div>
                <div class="col-6 px-4">
                    <div class="info-label mb-4">LA DIRECTION</div>
                    <div class="border-bottom border-dark mx-auto" style="width: 80%; opacity: 0.1;"></div>
                    <small class="text-muted fst-italic mt-2 d-block x-small" style="font-size: 0.65rem;">Cachet et Signature autorisée</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

