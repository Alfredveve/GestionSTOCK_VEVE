{% extends 'inventory/base.html' %}
{% load inventory_extras %}
{% load static %}

{% block title %}Rapports Avancés - GestionSTOCK{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
    <!-- Modern Header with Gradient -->
    <div class="modern-header mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div>
                <h1 class="text-white fw-bold d-flex align-items-center mb-1 gap-2">
                    <span class="symbol symbol-35px me-2">
                        <span class="symbol-label bg-white text-primary rounded-circle">
                            <i class="fas fa-chart-line fs-4"></i>
                        </span>
                    </span>
                    Rapports Avancés
                </h1>
                <span class="text-white opacity-75 fs-6 fw-bold">Analyse complète de votre activité</span>
            </div>
            <div class="d-flex gap-2 mt-3 mt-md-0">
                <button onclick="window.print()" class="btn btn-custom btn-white btn-active-light-primary text-primary fw-bold btn-sm d-print-none">
                    <i class="fas fa-print me-2"></i> Imprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Filter Card -->
    <div class="card card-premium mb-6 d-print-none">
        <div class="card-body p-5">
            <form method="get" class="d-flex align-items-end gap-4 flex-wrap">
                <div class="d-flex flex-column flex-fill" style="min-width: 200px;">
                    <label class="form-label fs-6 fw-bold text-gray-700 mb-2">
                        <i class="fas fa-calendar-day text-info me-2"></i>Journée précise
                    </label>
                    <input type="date" name="date" class="form-control form-control-modern" 
                        value="{{ specific_date|default:'' }}">
                </div>
                <div class="d-flex flex-column flex-fill" style="min-width: 200px;">
                    <label class="form-label fs-6 fw-bold text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>Date de début
                    </label>
                    <input type="date" name="start_date" class="form-control form-control-modern" 
                        value="{{ start_date|date:'Y-m-d'|default:'' }}">
                </div>
                <div class="d-flex flex-column flex-fill" style="min-width: 200px;">
                    <label class="form-label fs-6 fw-bold text-gray-700 mb-2">
                        <i class="fas fa-calendar-check text-primary me-2"></i>Date de fin
                    </label>
                    <input type="date" name="end_date" class="form-control form-control-modern" 
                        value="{{ end_date|date:'Y-m-d'|default:'' }}">
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-modern px-6">
                        <i class="fas fa-search me-2"></i> Filtrer
                    </button>
                    {% if start_date or end_date or specific_date %}
                    <a href="{% url 'inventory:advanced_reports' %}" class="btn btn-light-danger btn-modern px-4" 
                       title="Effacer les filtres">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
            {% if start_date or end_date %}
            <div class="mt-3">
                <span class="badge badge-glass-primary">
                    <i class="fas fa-filter me-1"></i>
                    Période: {{ start_date|date:"d/m/Y"|default:"Début" }} - {{ end_date|date:"d/m/Y"|default:"Aujourd'hui" }}
                </span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-6">
        <!-- 1. Activités Récentes des Ventes -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-success">
                                <i class="fas fa-shopping-cart text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">Activités Récentes des Ventes</h3>
                            <span class="card-subtitle-modern">Historique des transactions</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_sales_activities_excel' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_sales_activities_pdf' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-100px">Date</th>
                                    <th class="min-w-100px">N° Facture</th>
                                    <th class="min-w-150px">Client</th>
                                    <th class="min-w-150px">Produit</th>
                                    <th class="text-end min-w-100px">Quantité</th>
                                    <th class="text-end min-w-100px">Prix Unit.</th>
                                    <th class="text-end min-w-100px">Total</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% if sales_activities %}
                                {% with currency=company_settings.currency %}
                                {% for item in sales_activities %}
                                <tr class="table-row-hover">
                                    <td>{{ item.invoice.date_issued|date:"d/m/Y" }}</td>
                                    <td><span class="badge badge-modern badge-dark">{{ item.invoice.invoice_number }}</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="symbol symbol-35px symbol-circle me-2">
                                                <span class="symbol-label bg-gradient-primary text-white fw-bold">
                                                    {{ item.invoice.client.name|first|upper }}
                                                </span>
                                            </div>
                                            <span class="text-gray-800 text-hover-primary mb-1">{{ item.invoice.client.name }}</span>
                                        </div>
                                    </td>
                                    <td><span class="text-dark fw-bolder">{{ item.product.name }}</span></td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ item.unit_price|format_currency:currency }}</td>
                                    <td class="text-end text-success fw-bolder">{{ item.total|format_currency:currency }}</td>
                                </tr>
                                {% endfor %}
                                {% endwith %}
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="fas fa-inbox fs-2tx text-primary mb-4"></i>
                                            <h4 class="text-gray-900 fw-bolder mb-2">Aucune donnée</h4>
                                            <div class="fs-6 text-gray-700">Aucune activité de vente trouvée pour cette période.</div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. État des Factures -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-info">
                                <i class="fas fa-file-invoice-dollar text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">État des Factures</h3>
                            <span class="card-subtitle-modern">Suivi des paiements</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_invoice_status_excel' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_invoice_status_pdf' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Stats Cards -->
                    <div class="row g-4 mb-6">
                        <div class="col-md-4">
                            <div class="stat-card stat-card-success">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Payées</div>
                                    <div class="stat-value">{{ invoices_paid.count }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card stat-card-warning">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">En Attente</div>
                                    <div class="stat-value">{{ invoices_pending.count }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card stat-card-danger">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">En Retard</div>
                                    <div class="stat-value">{{ invoices_overdue.count }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-100px">N° Facture</th>
                                    <th class="min-w-150px">Client</th>
                                    <th class="min-w-100px">Date</th>
                                    <th class="min-w-100px">Échéance</th>
                                    <th class="min-w-100px">Statut</th>
                                    <th class="text-end min-w-100px">Montant</th>
                                    <th class="text-end min-w-100px">Solde</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% with currency=company_settings.currency %}
                                
                                {% for invoice in invoices_paid|slice:":10" %}
                                <tr class="table-row-hover">
                                    <td><span class="badge badge-modern badge-dark">{{ invoice.invoice_number }}</span></td>
                                    <td>{{ invoice.client.name }}</td>
                                    <td>{{ invoice.date_issued|date:"d/m/Y" }}</td>
                                    <td>{{ invoice.date_due|date:"d/m/Y" }}</td>
                                    <td><span class="badge badge-modern badge-success">{{ invoice.get_status_display }}</span></td>
                                    <td class="text-end">{{ invoice.total_amount|format_currency:currency }}</td>
                                    <td class="text-end fw-bolder">{{ invoice.get_remaining_amount|format_currency:currency }}</td>
                                </tr>
                                {% endfor %}

                                {% for invoice in invoices_pending|slice:":10" %}
                                <tr class="table-row-hover">
                                    <td><span class="badge badge-modern badge-dark">{{ invoice.invoice_number }}</span></td>
                                    <td>{{ invoice.client.name }}</td>
                                    <td>{{ invoice.date_issued|date:"d/m/Y" }}</td>
                                    <td>{{ invoice.date_due|date:"d/m/Y" }}</td>
                                    <td><span class="badge badge-modern badge-warning">{{ invoice.get_status_display }}</span></td>
                                    <td class="text-end">{{ invoice.total_amount|format_currency:currency }}</td>
                                    <td class="text-end fw-bolder text-warning">{{ invoice.get_remaining_amount|format_currency:currency }}</td>
                                </tr>
                                {% endfor %}
                                
                                {% if not invoices_paid and not invoices_pending %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="text-gray-500 fs-6">Aucune facture à afficher</div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endwith %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Répartition du Stock par Magasin -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-primary">
                                <i class="fas fa-store text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">Répartition du stock</h3>
                            <span class="card-subtitle-modern">Par point de vente</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_stock_distribution_excel' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_stock_distribution_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-150px">Point de Vente</th>
                                    <th class="min-w-100px">Code</th>
                                    <th class="text-end min-w-100px">Nb Produits</th>
                                    <th class="text-end min-w-100px">Quantité Totale</th>
                                    <th class="text-end min-w-100px">Valeur Totale</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% if stock_by_pos %}
                                {% with currency=company_settings.currency %}
                                {% for item in stock_by_pos %}
                                <tr class="table-row-hover">
                                    <td class="text-dark fw-bolder">{{ item.point_of_sale__name }}</td>
                                    <td><span class="badge badge-modern badge-primary">{{ item.point_of_sale__code }}</span></td>
                                    <td class="text-end">{{ item.total_products }}</td>
                                    <td class="text-end text-dark">{{ item.total_quantity|default:0 }}</td>
                                    <td class="text-end text-success fw-bolder">{{ item.total_value|default:0|format_currency:currency }}</td>
                                </tr>
                                {% endfor %}
                                {% endwith %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="text-gray-500 fs-6">Aucun stock disponible</div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Produits en Stock Faible -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100 card-accent-warning">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-warning">
                                <i class="fas fa-exclamation-triangle text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">Produits en Stock Faible</h3>
                            <span class="card-subtitle-modern">Nécessitent un réapprovisionnement</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_low_stock_excel' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_low_stock_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-150px">Produit</th>
                                    <th class="min-w-100px">SKU</th>
                                    <th class="min-w-150px">Point de Vente</th>
                                    <th class="text-end min-w-100px">Quantité</th>
                                    <th class="text-end min-w-100px">Seuil</th>
                                    <th class="min-w-100px">Emplacement</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% if low_stock_products %}
                                {% for item in low_stock_products %}
                                <tr class="table-row-hover">
                                    <td>
                                        <span class="text-dark fw-bolder text-hover-primary">{{ item.product.name }}</span>
                                    </td>
                                    <td><span class="badge badge-modern badge-dark">{{ item.product.sku }}</span></td>
                                    <td>{{ item.point_of_sale.name }}</td>
                                    <td class="text-end"><span class="badge badge-modern badge-warning">{{ item.quantity }}</span></td>
                                    <td class="text-end">{{ item.reorder_level }}</td>
                                    <td>{{ item.location|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="success-state">
                                            <i class="fas fa-check-circle fs-2hx text-success mb-4"></i>
                                            <h4 class="mb-1 text-success">Tout va bien !</h4>
                                            <span>Aucun produit en stock faible actuellement.</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Derniers Mouvements de Stock -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-info">
                                <i class="fas fa-exchange-alt text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">Mouvements de Stock</h3>
                            <span class="card-subtitle-modern">Historique récent</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_stock_movements_excel' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_stock_movements_pdf' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-150px">Date</th>
                                    <th class="min-w-200px">Produit</th>
                                    <th class="min-w-100px">Type</th>
                                    <th class="text-end min-w-100px">Quantité</th>
                                    <th class="min-w-150px">Point de Vente</th>
                                    <th class="min-w-150px">Utilisateur</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% if stock_movements %}
                                {% for movement in stock_movements %}
                                <tr class="table-row-hover">
                                    <td>{{ movement.created_at|date:"d/m/Y H:i" }}</td>
                                    <td class="text-dark fw-bolder">{{ movement.product.name }}</td>
                                    <td>
                                        {% if movement.movement_type == 'entry' %}
                                        <span class="badge badge-modern badge-success">
                                            <i class="fas fa-arrow-down me-1"></i> Entrée
                                        </span>
                                        {% elif movement.movement_type == 'exit' %}
                                        <span class="badge badge-modern badge-danger">
                                            <i class="fas fa-arrow-up me-1"></i> Sortie
                                        </span>
                                        {% elif movement.movement_type == 'return' %}
                                        <span class="badge badge-modern badge-warning">
                                            <i class="fas fa-undo me-1"></i> Retour
                                        </span>
                                        {% else %}
                                        <span class="badge badge-modern badge-info">
                                            <i class="fas fa-exchange-alt me-1"></i> {{ movement.get_movement_type_display }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bolder">{{ movement.quantity }}</td>
                                    <td>{{ movement.from_point_of_sale.name }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="symbol symbol-25px symbol-circle me-2">
                                                <span class="symbol-label bg-light text-gray-600 fs-8 fw-bold">
                                                    {{ movement.user.username|first|upper }}
                                                </span>
                                            </div>
                                            <span>{{ movement.user.username }}</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="text-gray-500 fs-6">Aucun mouvement récent</div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. Produits Retournés -->
        <div class="col-12">
            <div class="card card-modern card-flush h-xl-100 card-accent-info">
                <div class="card-header-modern">
                    <div class="d-flex align-items-center gap-3">
                        <div class="symbol symbol-50px">
                            <span class="symbol-label bg-gradient-purple">
                                <i class="fas fa-undo-alt text-white fs-2"></i>
                            </span>
                        </div>
                        <div>
                            <h3 class="card-title-modern mb-1">Produits Retournés</h3>
                            <span class="card-subtitle-modern">Retours clients et fournisseurs</span>
                        </div>
                    </div>
                    <div class="card-toolbar d-print-none">
                        <a href="{% url 'inventory:export_returned_products_excel' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-success me-2 btn-hover-scale">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="{% url 'inventory:export_returned_products_pdf' %}?{{ request.GET.urlencode }}"
                            class="btn btn-sm btn-light-danger btn-hover-scale" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern align-middle table-row-dashed fs-6 gy-3">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-100px">Date</th>
                                    <th class="min-w-150px">Produit</th>
                                    <th class="text-end min-w-100px">Quantité</th>
                                    <th class="min-w-150px">Point de Vente</th>
                                    <th class="min-w-100px">Référence</th>
                                    <th class="min-w-200px">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600">
                                {% if returned_products %}
                                {% for item in returned_products %}
                                <tr class="table-row-hover">
                                    <td>{{ item.created_at|date:"d/m/Y H:i" }}</td>
                                    <td class="text-dark fw-bolder">{{ item.product.name }}</td>
                                    <td class="text-end text-info fw-bolder">{{ item.quantity }}</td>
                                    <td>{{ item.from_point_of_sale.name }}</td>
                                    <td><span class="badge badge-modern badge-dark">{{ item.reference|default:"-" }}</span></td>
                                    <td class="text-gray-500">{{ item.notes|default:"-"|truncatewords:8 }}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="success-state">
                                            <i class="fas fa-check-circle fs-2hx text-success mb-4"></i>
                                            <h4 class="mb-1 text-success">Aucun retour</h4>
                                            <span>Aucun produit retourné sur la période.</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animate cards on scroll
        const cards = document.querySelectorAll('.card-modern');
        
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '0';
                    entry.target.style.transform = 'translateY(30px)';
                    
                    setTimeout(() => {
                        entry.target.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, 100);
                    
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        cards.forEach((card, index) => {
            setTimeout(() => {
                observer.observe(card);
            }, index * 100);
        });

        // Animate stat values
        const statValues = document.querySelectorAll('.stat-value');
        statValues.forEach(stat => {
            const finalValue = parseInt(stat.textContent);
            if (!isNaN(finalValue)) {
                let currentValue = 0;
                const increment = finalValue / 30;
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        stat.textContent = finalValue;
                        clearInterval(timer);
                    } else {
                        stat.textContent = Math.floor(currentValue);
                    }
                }, 30);
            }
        });
    });
</script>

{% endblock %}
