{% load static %}
<!-- Metronic Header -->
<nav class="navbar navbar-expand-lg metronic-header sticky-top print-hidden">
    <div class="container-fluid px-4 position-relative">
        <!-- Branding -->
        <a class="navbar-brand d-flex align-items-center" href="{% url 'inventory:dashboard' %}">
            <div class="icon-shape-metronic shadow-sm me-2">
                <i class="bi bi-box-seam fs-4"></i>
            </div>
            <div class="d-flex flex-column">
                <span class="metronic-brand lh-1">E-Stock</span>
            </div>
        </a>

        <!-- Mobile Toggle -->
        <button class="navbar-toggler p-2 border-0" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#mobileMenu">
            <span class="bi bi-list fs-1 text-white"></span>
        </button>

        <!-- Desktop Menu (Flex Centered Safe) -->
        <div class="collapse navbar-collapse" id="desktopNavBar">
            <ul class="navbar-nav mx-auto">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                        href="{% url 'inventory:dashboard' %}">
                        Dashboard
                    </a>
                </li>

                <!-- Produits -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'product' in request.resolver_match.url_name or 'category' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        Produits
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:product_list' %}">Liste des
                                produits</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:product_create' %}">Nouveau
                                produit</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:category_list' %}">Catégories</a>
                        </li>
                    </ul>
                </li>

                <!-- Stock -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'inventory' in request.resolver_match.url_name or 'movement' in request.resolver_match.url_name or 'receipt' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        Stock
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:inventory_list' %}">État du
                                Stock</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:movement_list' %}">Historique</a>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:movement_create' %}">Entrée/Sortie</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:receipt_list' %}">Bons de
                                Réception</a></li>
                    </ul>
                </li>

                <!-- Ventes -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'invoice' in request.resolver_match.url_name or 'quote' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        Ventes
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:quote_list' %}">Devis &
                                Commandes</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:invoice_list' %}">Factures</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:invoice_create' %}">Nouvelle
                                Facture</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item fw-bold text-primary" href="{% url 'inventory:quick_sale' %}">
                            <i class="fas fa-bolt me-2"></i>Vente Rapide (POS)
                        </a></li>
                    </ul>
                </li>

                <!-- Contacts -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'client' in request.resolver_match.url_name or 'supplier' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        Contacts
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:client_list' %}">Clients</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:supplier_list' %}">Fournisseurs</a>
                        </li>
                    </ul>
                </li>

                <!-- Points de Vente -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'pos' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        POS
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:pos_list' %}">Liste des POS</a>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:bulk_stock_configuration' %}">Config.
                                Stock</a></li>
                    </ul>
                </li>

                <!-- Rapports -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'report' in request.resolver_match.url_name or 'payment' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        Rapports
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:reports' %}">Tableau de bord</a>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:payment_list' %}">Finance &
                                Paiements</a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:advanced_reports' %}">Analyses
                                Avancées</a></li>
                    </ul>
                </li>
            </ul>

            <!-- User Profile (Right Aligned) -->
            <div class="navbar-nav ms-auto">
                <li class="nav-item dropdown group">
                    <a class="user-profile-toggle" href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static"
                        aria-expanded="false">
                        <div class="user-avatar-wrapper shadow-sm">
                            {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}"
                                class="user-avatar-img">
                            {% else %}
                            <div class="user-avatar-placeholder gradient-bg">
                                {{ user.username|make_list|first|upper }}
                            </div>
                            {% endif %}
                            <span class="user-status-indicator pulse-ring"></span>
                        </div>
                        <div class="user-info ps-2 d-none d-xl-block">
                             <div class="user-name">{{ user.first_name|default:user.username }}</div>
                        </div>
                        <i class="bi bi-chevron-down ms-2 d-none d-xl-block fs-9 text-muted"></i>
                    </a>
                    <ul class="dropdown-menu user-dropdown-menu animate slideIn">
                        <li class="user-info-header">
                            <div class="d-flex align-items-center p-3">
                                <div class="user-avatar-wrapper-large me-3 shadow-sm">
                                    {% if user.profile.avatar %}
                                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}"
                                        class="user-avatar-img">
                                    {% else %}
                                    <div class="user-avatar-placeholder gradient-bg">
                                        {{ user.username|make_list|first|upper }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <div class="fw-bold text-dark text-truncate">{{ user.get_full_name|default:user.username }}</div>
                                    <div class="text-muted small text-truncate">{{ user.email }}</div>
                                    <div class="badge bg-light-success text-success mt-1">
                                        En ligne
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider my-2"></li>
                        
                        <li>
                            <a class="dropdown-item fw-bold text-primary" href="{% url 'inventory:quick_sale' %}">
                                <span class="icon-wrapper me-2"><i class="fas fa-bolt"></i></span>
                                <span>Vente Rapide (POS)</span>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider my-2"></li>
                        
                        <li>
                            <a class="dropdown-item" href="{% url 'inventory:settings' %}">
                                <span class="icon-wrapper me-2"><i class="bi bi-gear"></i></span>
                                <span>Paramètres</span>
                            </a>
                        </li>
                        {% if user.is_staff %}
                        <li>
                            <a class="dropdown-item" href="{% url 'inventory:user_list' %}">
                                <span class="icon-wrapper me-2"><i class="bi bi-people"></i></span>
                                <span>Utilisateurs</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/admin/">
                                <span class="icon-wrapper me-2"><i class="bi bi-shield-lock"></i></span>
                                <span>Administration</span>
                            </a>
                        </li>
                        {% endif %}
                        <li><hr class="dropdown-divider my-2"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'inventory:logout' %}">
                                <span class="icon-wrapper me-2"><i class="bi bi-box-arrow-right"></i></span>
                                <span>Déconnexion</span>
                            </a>
                        </li>
                    </ul>
                </li>
            </div>
        </div>
    </div>
</nav>

<!-- Clean Dark Mobile Offcanvas -->
<div class="offcanvas offcanvas-start bg-metronic-mobile text-white" tabindex="-1" id="mobileMenu"
    aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title d-flex align-items-center gap-2" id="mobileMenuLabel">
            <span class="fw-bold tracking-tight">GestionSTOCK</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="list-group list-group-flush rounded-0 theme-dark-list">
            <a href="{% url 'inventory:dashboard' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 py-3 border-secondary">
                <i class="bi bi-speedometer2 me-3"></i> Tableau de bord
            </a>

            <!-- Mobile Accordion Menu -->
            <div class="accordion accordion-flush bg-transparent" id="mobileMenuAccordion">
                
                <!-- Produits -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingProduits">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapseProduits" aria-expanded="false"
                            aria-controls="flush-collapseProduits">
                            <i class="bi bi-tags me-3"></i> Produits
                        </button>
                    </h2>
                    <div id="flush-collapseProduits" class="accordion-collapse collapse" aria-labelledby="flush-headingProduits"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:product_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Liste des produits</a>
                                <a href="{% url 'inventory:product_create' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Nouveau produit</a>
                                <a href="{% url 'inventory:category_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Catégories</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingStock">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapseStock" aria-expanded="false"
                            aria-controls="flush-collapseStock">
                            <i class="bi bi-boxes me-3"></i> Stock
                        </button>
                    </h2>
                    <div id="flush-collapseStock" class="accordion-collapse collapse" aria-labelledby="flush-headingStock"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:inventory_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>État du Stock</a>
                                <a href="{% url 'inventory:movement_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Historique</a>
                                <a href="{% url 'inventory:movement_create' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Entrée/Sortie</a>
                                <a href="{% url 'inventory:receipt_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Bons de Réception</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ventes -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingVentes">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapseVentes" aria-expanded="false"
                            aria-controls="flush-collapseVentes">
                            <i class="bi bi-cart3 me-3"></i> Ventes
                        </button>
                    </h2>
                    <div id="flush-collapseVentes" class="accordion-collapse collapse" aria-labelledby="flush-headingVentes"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:quote_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Devis & Commandes</a>
                                <a href="{% url 'inventory:invoice_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Factures</a>
                                <a href="{% url 'inventory:invoice_create' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Nouvelle Facture</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingContacts">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapseContacts" aria-expanded="false"
                            aria-controls="flush-collapseContacts">
                            <i class="bi bi-people me-3"></i> Contacts
                        </button>
                    </h2>
                    <div id="flush-collapseContacts" class="accordion-collapse collapse" aria-labelledby="flush-headingContacts"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:client_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Clients</a>
                                <a href="{% url 'inventory:supplier_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Fournisseurs</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POS -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingPOS">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapsePOS" aria-expanded="false"
                            aria-controls="flush-collapsePOS">
                            <i class="bi bi-shop me-3"></i> POS
                        </button>
                    </h2>
                    <div id="flush-collapsePOS" class="accordion-collapse collapse" aria-labelledby="flush-headingPOS"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:pos_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Liste des POS</a>
                                <a href="{% url 'inventory:bulk_stock_configuration' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Config. Stock</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rapports -->
                <div class="accordion-item bg-transparent border-secondary">
                    <h2 class="accordion-header" id="flush-headingRapports">
                        <button class="accordion-button collapsed bg-transparent text-white-50 shadow-none py-3" type="button"
                            data-bs-toggle="collapse" data-bs-target="#flush-collapseRapports" aria-expanded="false"
                            aria-controls="flush-collapseRapports">
                            <i class="bi bi-bar-chart me-3"></i> Rapports
                        </button>
                    </h2>
                    <div id="flush-collapseRapports" class="accordion-collapse collapse" aria-labelledby="flush-headingRapports"
                        data-bs-parent="#mobileMenuAccordion">
                        <div class="accordion-body py-0 bg-black bg-opacity-10">
                            <div class="list-group list-group-flush">
                                <a href="{% url 'inventory:reports' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Tableau de bord</a>
                                <a href="{% url 'inventory:payment_list' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Finance & Paiements</a>
                                <a href="{% url 'inventory:advanced_reports' %}" class="list-group-item bg-transparent text-white-50 border-0 ps-5"><i class="bi bi-dot me-2"></i>Analyses Avancées</a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="mt-auto p-3">
            <a href="{% url 'inventory:logout' %}" class="btn btn-danger w-100">Déconnexion</a>
        </div>
    </div>
</div>