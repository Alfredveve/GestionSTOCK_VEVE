{% extends 'inventory/base.html' %}

{% block title %}Ajouter un article - Facture {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-5xl">
    <!-- En-tête de la page -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Ajouter un article
                </h1>
                <p class="text-gray-600 mt-1">Facture {{ invoice.invoice_number }} - {{ invoice.client.name }}</p>
            </div>
            <a href="{% url 'inventory:invoice_detail' invoice.pk %}" class="btn btn-ghost btn-sm gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Retour
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Formulaire principal -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-xl mb-4">Informations de l'article</h2>
                    
                    <form method="post" id="invoiceItemForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-error mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>{{ form.non_field_errors }}</span>
                            </div>
                        {% endif %}

                        <!-- Sélection du produit -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text font-semibold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                    {{ form.product.label }}
                                </span>
                                <span class="label-text-alt tooltip tooltip-left" data-tip="Le prix sera auto-rempli">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </span>
                            </label>
                            {{ form.product }}
                            {% if form.product.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.product.errors.0 }}</span>
                                </label>
                            {% elif form.product.help_text %}
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">{{ form.product.help_text }}</span>
                                </label>
                            {% endif %}
                        </div>

                        <!-- Grille pour quantité et prix -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- Quantité -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                        </svg>
                                        {{ form.quantity.label }}
                                    </span>
                                </label>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.quantity.errors.0 }}</span>
                                    </label>
                                {% elif form.quantity.help_text %}
                                    <label class="label">
                                        <span class="label-text-alt text-gray-500">{{ form.quantity.help_text }}</span>
                                    </label>
                                {% endif %}
                            </div>

                            <!-- Prix unitaire -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {{ form.unit_price.label }}
                                    </span>
                                    <span class="label-text-alt tooltip tooltip-left" data-tip="Modifiable manuellement">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                        </svg>
                                    </span>
                                </label>
                                {{ form.unit_price }}
                                {% if form.unit_price.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.unit_price.errors.0 }}</span>
                                    </label>
                                {% elif form.unit_price.help_text %}
                                    <label class="label">
                                        <span class="label-text-alt text-gray-500">{{ form.unit_price.help_text }}</span>
                                    </label>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Remise -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text font-semibold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                    {{ form.discount.label }}
                                </span>
                                <span class="label-text-alt text-gray-500">Optionnel</span>
                            </label>
                            {{ form.discount }}
                        </div>

                        <!-- Option Vente en Gros -->
                        <div class="form-control mb-6 bg-base-200 p-4 rounded-lg border-2 border-dashed border-primary/20">
                            <label class="label cursor-pointer flex justify-start gap-4">
                                {{ form.is_wholesale }}
                                <span class="label-text font-bold text-lg flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                    Vendre par Carton (Prix de Gros)
                                </span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-10">Si coché, le stock sera déduit par carton (ex: 1 carton = 12 unités).</p>
                        </div>

                        <!-- Aperçu du total -->
                        <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-lg p-4 mb-6" id="totalPreview" style="display: none;">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-700">Total de la ligne :</span>
                                <span class="text-2xl font-bold text-primary" id="lineTotal">0.00 GNF</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-2" id="calculationDetails"></div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="flex gap-3 justify-end">
                            <a href="{% url 'inventory:invoice_detail' invoice.pk %}" class="btn btn-ghost gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Ajouter l'article
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panneau d'information produit -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-xl sticky top-4" id="productInfoCard" style="display: none;">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Informations produit
                    </h3>
                    
                    <div class="space-y-3">
                        <!-- Nom du produit -->
                        <div class="bg-base-200 rounded-lg p-3">
                            <div class="text-xs text-gray-500 mb-1">Produit</div>
                            <div class="font-semibold" id="productName">-</div>
                            <div class="text-xs text-gray-500" id="productSKU">-</div>
                        </div>

                        <!-- Prix et marge -->
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="text-xs text-gray-500 mb-1">Prix d'achat</div>
                                <div class="font-bold text-sm" id="purchasePrice">-</div>
                            </div>
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="text-xs text-gray-500 mb-1">Marge</div>
                                <div class="font-bold text-sm text-success" id="margin">-</div>
                            </div>
                        </div>

                        <!-- Prix de vente suggéré -->
                        <div class="bg-gradient-to-r from-primary/20 to-secondary/20 rounded-lg p-3">
                            <div class="text-xl font-bold text-primary" id="sellingPrice">-</div>
                        </div>

                        <!-- Info Carton (si gros) -->
                        <div id="boxInfo" style="display: none;" class="bg-primary/5 rounded-lg p-3 border border-primary/10">
                            <div class="text-xs text-primary font-semibold mb-1 uppercase">Détails Carton</div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Unités par carton:</span>
                                <span class="font-bold" id="unitsPerBox">-</span>
                            </div>
                        </div>

                        <!-- Stock disponible -->
                        <div class="divider my-2"></div>
                        <div id="stockInfo">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">Stock disponible</span>
                                <span class="badge badge-sm" id="stockBadge">-</span>
                            </div>
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-500">Quantité</span>
                                    <span class="font-bold text-lg" id="stockQuantity">-</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1" id="stockLocation"></div>
                            </div>
                        </div>

                        <!-- Stock total -->
                        <div class="text-xs text-gray-500 text-center pt-2 border-t">
                            Stock total (tous points de vente) : <span class="font-semibold" id="totalStock">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aide -->
            <div class="card bg-info/10 shadow-lg mt-4">
                <div class="card-body p-4">
                    <div class="flex gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="text-sm">
                            <p class="font-semibold mb-1">Astuce</p>
                            <p class="text-xs text-gray-600">Le prix unitaire est automatiquement rempli avec le prix de vente du produit, mais vous pouvez le modifier si nécessaire.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Format currency with thousand separators (spaces)
function formatCurrency(amount) {
    const num = parseFloat(amount);
    if (isNaN(num)) return '0.00 GNF';
    
    const formatted = num.toFixed(2);
    const parts = formatted.split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];
    
    // Add spaces as thousand separators
    let integerWithSpaces = '';
    for (let i = 0; i < integerPart.length; i++) {
        if (i > 0 && (integerPart.length - i) % 3 === 0) {
            integerWithSpaces += ' ';
        }
        integerWithSpaces += integerPart[i];
    }
    
    return `${integerWithSpaces}.${decimalPart} GNF`;
}

document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('id_product');
    const quantityInput = document.getElementById('id_quantity');
    const unitPriceInput = document.getElementById('id_unit_price');
    const discountInput = document.getElementById('id_discount');
    const isWholesaleInput = document.getElementById('id_is_wholesale');
    const productInfoCard = document.getElementById('productInfoCard');
    const totalPreview = document.getElementById('totalPreview');
    
    let currentProductData = null;
    
    // Animation d'entrée pour la carte d'information
    function showCardWithAnimation(element) {
        element.style.display = 'block';
        element.style.opacity = '0';
        element.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            element.style.transition = 'all 0.3s ease-in-out';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, 10);
    }
    
    // Feedback visuel pour les champs modifiés
    function highlightField(input) {
        input.classList.add('ring-2', 'ring-primary', 'ring-opacity-50');
        setTimeout(() => {
            input.classList.remove('ring-2', 'ring-primary', 'ring-opacity-50');
        }, 1000);
    }
    
    // Point de vente de la facture (pour récupérer le stock)
    const invoicePointOfSale = {{ invoice.point_of_sale.id|default:'null' }};
    
    // Auto-remplissage du prix et affichage des infos produit
    productSelect.addEventListener('change', function() {
        const productId = this.value;
        
        if (!productId) {
            productInfoCard.style.display = 'none';
            unitPriceInput.value = '';
            return;
        }
        
        // Construire l'URL avec le point de vente si disponible
        let url = `/inventory/api/product/${productId}/info/`;
        if (invoicePointOfSale) {
            url += `?pos_id=${invoicePointOfSale}`;
        }
        
        // Récupérer les informations du produit via AJAX
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }
                
                // Remplir le prix unitaire avec le prix de vente
                currentProductData = data;
                updatePriceFromWholesale();
                
                // Afficher les informations du produit
                document.getElementById('productName').textContent = data.name;
                document.getElementById('productSKU').textContent = `SKU: ${data.sku}`;
                document.getElementById('purchasePrice').textContent = formatCurrency(isWholesaleInput.checked ? data.wholesale_purchase_price : data.purchase_price);
                document.getElementById('margin').textContent = isWholesaleInput.checked ? formatCurrency(data.wholesale_margin) : `${data.margin}%`;
                document.getElementById('sellingPrice').textContent = formatCurrency(isWholesaleInput.checked ? data.wholesale_selling_price : data.selling_price);
                document.getElementById('totalStock').textContent = `${data.total_stock} unités`;
                
                // Info Carton
                document.getElementById('unitsPerBox').textContent = data.units_per_box;
                document.getElementById('boxInfo').style.display = data.units_per_box > 1 ? 'block' : 'none';
                
                // Afficher les informations de stock du point de vente
                if (data.stock_info && Object.keys(data.stock_info).length > 0) {
                    const stockInfo = data.stock_info;
                    document.getElementById('stockQuantity').textContent = stockInfo.quantity;
                    
                    // Badge de statut
                    const stockBadge = document.getElementById('stockBadge');
                    stockBadge.textContent = stockInfo.status_display;
                    stockBadge.className = 'badge badge-sm';
                    
                    if (stockInfo.status === 'in_stock') {
                        stockBadge.classList.add('badge-success');
                    } else if (stockInfo.status === 'low_stock') {
                        stockBadge.classList.add('badge-warning');
                    } else {
                        stockBadge.classList.add('badge-error');
                    }
                    
                    // Emplacement
                    const locationText = stockInfo.location ? `Emplacement: ${stockInfo.location}` : 'Emplacement non défini';
                    document.getElementById('stockLocation').textContent = locationText;
                } else {
                    document.getElementById('stockQuantity').textContent = 'N/A';
                    document.getElementById('stockBadge').textContent = 'Pas de stock';
                    document.getElementById('stockBadge').className = 'badge badge-sm badge-ghost';
                    document.getElementById('stockLocation').textContent = '';
                }
                
                // Afficher la carte d'information avec animation
                showCardWithAnimation(productInfoCard);
                
                // Calculer le total initial
                calculateTotal();
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des informations du produit:', error);
            });
    });
    
    // Mettre à jour le prix si on change l'option Gros/Détail
    function updatePriceFromWholesale() {
        if (!currentProductData) return;
        
        const isWholesale = isWholesaleInput.checked;
        const price = isWholesale ? currentProductData.wholesale_selling_price : currentProductData.selling_price;
        
        unitPriceInput.value = price;
        highlightField(unitPriceInput);
        
        // Mettre à jour l'affichage des infos
        document.getElementById('purchasePrice').textContent = formatCurrency(isWholesale ? currentProductData.wholesale_purchase_price : currentProductData.purchase_price);
        document.getElementById('margin').textContent = isWholesale ? formatCurrency(currentProductData.wholesale_margin) : `${currentProductData.margin}%`;
        document.getElementById('sellingPrice').textContent = formatCurrency(price);
        
        calculateTotal();
    }
    
    isWholesaleInput.addEventListener('change', updatePriceFromWholesale);
    
    // Calcul en temps réel du total
    function calculateTotal() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        
        if (quantity > 0 && unitPrice > 0) {
            const subtotal = quantity * unitPrice;
            const discountAmount = subtotal * (discount / 100);
            const total = subtotal - discountAmount;
            
            // Afficher le total
            document.getElementById('lineTotal').textContent = formatCurrency(total);
            
            // Afficher les détails du calcul
            const isWholesale = isWholesaleInput.checked;
            const unitLabel = isWholesale ? 'carton(s)' : 'unité(s)';
            let details = `${quantity} ${unitLabel} × ${formatCurrency(unitPrice)}`;
            if (discount > 0) {
                details += ` - ${discount}% (${formatCurrency(discountAmount)})`;
            }
            document.getElementById('calculationDetails').textContent = details;
            
            totalPreview.style.display = 'block';
        } else {
            totalPreview.style.display = 'none';
        }
    }
    
    // Écouter les changements pour le calcul en temps réel
    quantityInput.addEventListener('input', calculateTotal);
    unitPriceInput.addEventListener('input', calculateTotal);
    discountInput.addEventListener('input', calculateTotal);
    
    // Validation avant soumission
    document.getElementById('invoiceItemForm').addEventListener('submit', function(e) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        
        if (quantity <= 0) {
            e.preventDefault();
            alert('La quantité doit être supérieure à 0');
            quantityInput.focus();
            return false;
        }
        
        if (unitPrice <= 0) {
            e.preventDefault();
            alert('Le prix unitaire doit être supérieur à 0');
            unitPriceInput.focus();
            return false;
        }
    });
});
</script>
{% endblock %}
