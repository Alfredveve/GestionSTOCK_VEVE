<nav class="navbar navbar-expand-lg metronic-header sticky-top print-hidden">
    <div class="container-xxl px-4">

        <!-- BRAND -->
        <a class="navbar-brand me-xl-5" href="{% url 'inventory:dashboard' %}">
            <div class="icon-shape-metronic">
                <i class="bi bi-box-seam fs-4"></i>
            </div>
            <div class="d-flex flex-column">
                <span class="metronic-brand">GestionSTOCK</span>
            </div>
        </a>

        <!-- MOBILE TOGGLE -->
        <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#mobileMenu">
            <i class="bi bi-list fs-1"></i>
        </button>

        <!-- DESKTOP MENU -->
        <div class="collapse navbar-collapse" id="desktopNavBar">
            <ul class="navbar-nav mx-auto">

                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                        href="{% url 'inventory:dashboard' %}">
                        <span class="nav-text">Tableau de bord</span>
                    </a>
                </li>

                <!-- Produits -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'product' in request.resolver_match.url_name or 'category' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Produits
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:product_list' %}">
                                <i class="bi bi-list-ul"></i> Liste des produits
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:product_create' %}">
                                <i class="bi bi-plus-circle"></i> Nouveau produit
                            </a></li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:category_list' %}">
                                <i class="bi bi-folder"></i> Catégories
                            </a></li>
                    </ul>
                </li>

                <!-- Stock -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'inventory' in request.resolver_match.url_name or 'movement' in request.resolver_match.url_name or 'receipt' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Stock
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <h6 class="dropdown-header">Gestion</h6>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:inventory_list' %}">
                                <i class="bi bi-clipboard-data"></i> État du Stock
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:movement_list' %}">
                                <i class="bi bi-clock-history"></i> Historique
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:movement_create' %}">
                                <i class="bi bi-arrow-left-right"></i> Entrée/Sortie
                            </a></li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li>
                            <h6 class="dropdown-header">Réceptions</h6>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:receipt_list' %}">
                                <i class="bi bi-truck"></i> Bons de Réception
                            </a></li>
                    </ul>
                </li>

                <!-- Ventes -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'invoice' in request.resolver_match.url_name or 'quote' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Ventes
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:quote_list' %}">
                                <i class="bi bi-file-earmark-text"></i> Devis & Commandes
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:invoice_list' %}">
                                <i class="bi bi-receipt"></i> Factures
                            </a></li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:invoice_create' %}">
                                <i class="bi bi-plus-lg"></i> Nouvelle Facture
                            </a></li>
                    </ul>
                </li>

                <!-- Réseau -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'client' in request.resolver_match.url_name or 'supplier' in request.resolver_match.url_name or 'pos' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Réseau
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <h6 class="dropdown-header">Partenaires</h6>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:client_list' %}">
                                <i class="bi bi-people"></i> Clients
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:supplier_list' %}">
                                <i class="bi bi-building"></i> Fournisseurs
                            </a></li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li>
                            <h6 class="dropdown-header">Configuration</h6>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'inventory:pos_list' %}">
                                <i class="bi bi-shop"></i> Points de Vente
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:bulk_stock_configuration' %}">
                                <i class="bi bi-gear-wide-connected"></i> Config. Stock
                            </a></li>
                    </ul>
                </li>

                <!-- Rapports -->
                <li class="nav-item dropdown group">
                    <a class="nav-link dropdown-toggle {% if 'report' in request.resolver_match.url_name or 'payment' in request.resolver_match.url_name %}active{% endif %}"
                        href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Rapports
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'inventory:reports' %}">
                                <i class="bi bi-pie-chart"></i> Tableau de bord
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:payment_list' %}">
                                <i class="bi bi-cash-stack"></i> Finance
                            </a></li>
                        <li><a class="dropdown-item" href="{% url 'inventory:advanced_reports' %}">
                                <i class="bi bi-bar-chart-steps"></i> Analyses Avancées
                            </a></li>
                    </ul>
                </li>

            </ul>

            <!-- USER PROFILE -->
            <div class="ms-auto">
                <div class="dropdown">
                    <a class="user-profile-toggle dropdown-toggle no-arrow" href="#" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false">

                        <div class="user-text d-none d-lg-block">
                            <span class="user-name">{{ user.username }}</span>
                            <span class="user-role">
                                {% if user.is_staff %}Admin{% else %}Utilisateur{% endif %}
                            </span>
                        </div>

                        <div class="user-avatar-wrapper">
                            {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" alt="avatar" class="user-avatar-img">
                            {% else %}
                            <div class="user-avatar-placeholder">
                                {{ user.username|make_list|first|upper }}
                            </div>
                            {% endif %}
                            <span class="status-indicator"></span>
                        </div>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end py-2">
                        <li>
                            <div class="d-flex align-items-center px-4 py-3 border-bottom mb-2">
                                <div class="d-flex flex-column w-100">
                                    <span class="fw-bold fs-6 text-dark">{{ user.username }}</span>
                                    <span class="text-muted small user-email-centered">{{ user.email }}</span>
                                </div>
                            </div>
                        </li>
                        <li><a class="dropdown-item px-4" href="{% url 'inventory:settings' %}">
                                <i class="bi bi-gear me-2"></i> Mon Profil
                            </a></li>
                        {% if user.is_staff %}
                        <li><a class="dropdown-item px-4" href="{% url 'inventory:user_list' %}">
                                <i class="bi bi-people me-2"></i> Gérer Utilisateurs
                            </a></li>
                        {% endif %}
                        <li>
                            <div class="dropdown-divider my-2"></div>
                        </li>
                        <li><a class="dropdown-item px-4 text-danger" href="{% url 'inventory:logout' %}">
                                <i class="bi bi-box-arrow-right me-2"></i> Déconnexion
                            </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- MOBILE OFFCANVAS -->
<div class="offcanvas offcanvas-start bg-metronic-mobile border-end-0" tabindex="-1" id="mobileMenu"
    aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header border-bottom border-white border-opacity-10 py-4">
        <h5 class="offcanvas-title d-flex align-items-center gap-2 text-white" id="mobileMenuLabel">
            <span class="icon-shape-metronic shadow-none bg-transparent ps-0">
                <i class="bi bi-box-seam fs-3 text-primary"></i>
            </span>
            <span class="fw-bold">GestionSTOCK</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="list-group list-group-flush bg-transparent">
            <a href="{% url 'inventory:dashboard' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-3 px-4">
                <i class="bi bi-speedometer2 me-3"></i> Tableau de bord
            </a>

            <!-- Mobile Groups -->
            <div class="p-3 text-uppercase text-muted small fw-bold mt-2 px-4">Menu</div>

            <a href="{% url 'inventory:product_list' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-2 px-4">
                <i class="bi bi-tags me-3"></i> Produits
            </a>
            <a href="{% url 'inventory:inventory_list' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-2 px-4">
                <i class="bi bi-boxes me-3"></i> Stock
            </a>
            <a href="{% url 'inventory:invoice_list' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-2 px-4">
                <i class="bi bi-cart3 me-3"></i> Ventes
            </a>
            <a href="{% url 'inventory:client_list' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-2 px-4">
                <i class="bi bi-people me-3"></i> Partenaires
            </a>

            <div class="p-3 text-uppercase text-muted small fw-bold mt-2 px-4">Compte</div>
            <a href="{% url 'inventory:settings' %}"
                class="list-group-item list-group-item-action bg-transparent text-white-50 border-0 py-2 px-4">
                <i class="bi bi-gear me-3"></i> Paramètres
            </a>
            <a href="{% url 'inventory:logout' %}"
                class="list-group-item list-group-item-action bg-transparent text-danger border-0 py-2 px-4">
                <i class="bi bi-power me-3"></i> Déconnexion
            </a>
        </div>
    </div>
</div>

<script>
// Enable dropdown on hover for desktop
document.addEventListener('DOMContentLoaded', function() {
    // Only apply hover behavior on desktop (screen width > 992px)
    if (window.innerWidth > 992) {
        const dropdowns = document.querySelectorAll('.navbar-nav .dropdown');
        
        dropdowns.forEach(dropdown => {
            const toggle = dropdown.querySelector('.dropdown-toggle');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            let hoverTimeout;
            
            // Show dropdown on hover
            dropdown.addEventListener('mouseenter', function() {
                clearTimeout(hoverTimeout);
                
                // Close other dropdowns
                document.querySelectorAll('.navbar-nav .dropdown-menu.show').forEach(otherMenu => {
                    if (otherMenu !== menu) {
                        otherMenu.classList.remove('show');
                        const otherToggle = otherMenu.previousElementSibling;
                        if (otherToggle) {
                            otherToggle.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                // Show this dropdown
                menu.classList.add('show');
                toggle.setAttribute('aria-expanded', 'true');
            });
            
            // Hide dropdown on mouse leave with small delay
            dropdown.addEventListener('mouseleave', function() {
                hoverTimeout = setTimeout(() => {
                    menu.classList.remove('show');
                    toggle.setAttribute('aria-expanded', 'false');
                }, 200); // 200ms delay before closing
            });
            
            // Also keep click functionality
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const isShown = menu.classList.contains('show');
                
                // Close all dropdowns
                document.querySelectorAll('.navbar-nav .dropdown-menu.show').forEach(otherMenu => {
                    otherMenu.classList.remove('show');
                    const otherToggle = otherMenu.previousElementSibling;
                    if (otherToggle) {
                        otherToggle.setAttribute('aria-expanded', 'false');
                    }
                });
                
                // Toggle this dropdown
                if (!isShown) {
                    menu.classList.add('show');
                    toggle.setAttribute('aria-expanded', 'true');
                }
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.navbar-nav .dropdown')) {
                document.querySelectorAll('.navbar-nav .dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    const toggle = menu.previousElementSibling;
                    if (toggle) {
                        toggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });
    }
});
</script>
