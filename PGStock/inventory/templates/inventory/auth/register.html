{% extends 'inventory/base_auth.html' %}

{% block title %}Inscription - GestionSTOCK{% endblock %}

{% block content_auth %}
<form method="post" novalidate id="kt_sign_up_form">
    {% csrf_token %}
    <div style="display:none;">{{ form.honeypot }}</div>

    <div class="text-center mb-5">
        <h2 class="text-dark fw-bold mb-2">Inscription</h2>
        <div class="text-secondary">
            Créez votre compte GestionSTOCK
        </div>
    </div>

    <!-- Non-field errors -->
    {% if form.non_field_errors %}
    <div class="alert alert-modern alert-danger d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <div>{{ form.non_field_errors|join:", " }}</div>
    </div>
    {% endif %}

    <!-- Username Field -->
    <div class="mb-3">
        <label class="form-label fw-semibold text-gray-700 mb-2">Nom d'utilisateur</label>
        <div class="input-group-modern">
            <input type="text" 
                   class="form-control form-modern {% if form.username.errors %}is-invalid{% endif %}" 
                   id="floatingUsername"
                   name="{{ form.username.name }}" 
                   placeholder="Choisissez un nom d'utilisateur" 
                   autocomplete="username"
                   value="{{ form.username.value|default:'' }}" 
                   required>
            <i class="fas fa-user input-icon"></i>
        </div>
        {% if form.username.errors %}
        <div class="text-danger mt-2 small">
            <i class="fas fa-exclamation-circle me-1"></i>{{ form.username.errors.0 }}
        </div>
        {% endif %}
    </div>

    <!-- Email Field -->
    <div class="mb-3">
        <label class="form-label fw-semibold text-gray-700 mb-2">Adresse email</label>
        <div class="input-group-modern">
            <input type="email" 
                   class="form-control form-modern {% if form.email.errors %}is-invalid{% endif %}" 
                   id="floatingEmail"
                   name="{{ form.email.name }}" 
                   placeholder="votre@email.com" 
                   autocomplete="email"
                   value="{{ form.email.value|default:'' }}" 
                   required>
            <i class="fas fa-envelope input-icon"></i>
        </div>
        {% if form.email.errors %}
        <div class="text-danger mt-2 small">
            <i class="fas fa-exclamation-circle me-1"></i>{{ form.email.errors.0 }}
        </div>
        {% endif %}
    </div>

    <!-- Password Field -->
    <div class="mb-3">
        <label class="form-label fw-semibold text-gray-700 mb-2">Mot de passe</label>
        <div class="input-group-modern">
            <input type="password" 
                   class="form-control form-modern {% if form.password1.errors %}is-invalid{% endif %}" 
                   id="floatingPassword1"
                   name="{{ form.password1.name }}" 
                   placeholder="Créez un mot de passe sécurisé" 
                   autocomplete="new-password" 
                   required>
            <i class="fas fa-lock input-icon"></i>
            <button type="button" class="password-toggle" onclick="togglePassword('floatingPassword1', this)">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        
        <!-- Password Strength Indicator -->
        <div class="password-strength mt-2">
            <div class="strength-bar">
                <div class="strength-fill" id="strengthFill"></div>
            </div>
            <div class="strength-text small mt-1" id="strengthText">Entrez un mot de passe</div>
        </div>
        
        {% if form.password1.errors %}
        <div class="text-danger mt-2 small">
            <i class="fas fa-exclamation-circle me-1"></i>{{ form.password1.errors.0 }}
        </div>
        {% endif %}
    </div>

    <!-- Confirm Password Field -->
    <div class="mb-4">
        <label class="form-label fw-semibold text-gray-700 mb-2">Confirmer le mot de passe</label>
        <div class="input-group-modern">
            <input type="password" 
                   class="form-control form-modern {% if form.password2.errors %}is-invalid{% endif %}" 
                   id="floatingPassword2"
                   name="{{ form.password2.name }}" 
                   placeholder="Confirmez votre mot de passe" 
                   autocomplete="new-password" 
                   required>
            <i class="fas fa-lock input-icon"></i>
            <button type="button" class="password-toggle" onclick="togglePassword('floatingPassword2', this)">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        {% if form.password2.errors %}
        <div class="text-danger mt-2 small">
            <i class="fas fa-exclamation-circle me-1"></i>{{ form.password2.errors.0 }}
        </div>
        {% endif %}
    </div>

    <!-- Terms Checkbox -->
    <div class="form-check mb-4">
        <input class="form-check-input" type="checkbox" id="termsCheck" required>
        <label class="form-check-label small text-gray-600" for="termsCheck">
            J'accepte les <a href="#" class="link-gradient text-decoration-none">conditions d'utilisation</a> 
            et la <a href="#" class="link-gradient text-decoration-none">politique de confidentialité</a>
        </label>
    </div>

    <!-- Submit Button -->
    <button type="submit" id="kt_sign_up_submit" class="btn btn-gradient-success btn-lg w-100 mb-3">
        <span class="indicator-label">
            <i class="fas fa-user-plus me-2"></i>Créer mon compte
        </span>
        <span class="indicator-progress d-none">
            <span class="spinner-border spinner-border-sm align-middle me-2"></span>
            Création en cours...
        </span>
    </button>

    <!-- Login Link -->
    <div class="text-center">
        <span class="text-secondary small">Déjà un compte ?</span>
        <a href="{% url 'inventory:login' %}" class="link-gradient text-decoration-none fw-semibold small ms-1">
            Se connecter
        </a>
    </div>

</form>

<style>
    /* Password Strength Indicator */
    .password-strength {
        margin-top: 0.5rem;
    }

    .strength-bar {
        height: 6px;
        background: #E4E6EF;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .strength-fill {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
        border-radius: 10px;
    }

    .strength-fill.weak {
        width: 25%;
        background: linear-gradient(90deg, #F1416C 0%, #F1416C 100%);
    }

    .strength-fill.fair {
        width: 50%;
        background: linear-gradient(90deg, #FFC700 0%, #FFA800 100%);
    }

    .strength-fill.good {
        width: 75%;
        background: linear-gradient(90deg, #009EF7 0%, #0095E8 100%);
    }

    .strength-fill.strong {
        width: 100%;
        background: linear-gradient(90deg, #50CD89 0%, #3BA76D 100%);
    }

    .strength-text {
        color: #7E8299;
        font-weight: 500;
    }

    .strength-text.weak {
        color: #F1416C;
    }

    .strength-text.fair {
        color: #FFA800;
    }

    .strength-text.good {
        color: #009EF7;
    }

    .strength-text.strong {
        color: #50CD89;
    }

    /* Link Gradient */
    .link-gradient {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
    }

    .link-gradient:hover {
        filter: brightness(1.2);
    }

    /* Password Toggle */
    .password-toggle {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #7E8299;
        cursor: pointer;
        padding: 0.5rem;
        transition: color 0.3s ease;
        z-index: 10;
    }

    .password-toggle:hover {
        color: #00b09b;
    }

    /* Custom Checkbox */
    .form-check-input {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 6px;
        border: 2px solid #E4E6EF;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .form-check-input:checked {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        border-color: #00b09b;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 176, 155, 0.15);
        border-color: #00b09b;
    }

    .form-check-label {
        cursor: pointer;
        user-select: none;
    }
</style>

<script>
    // Toggle Password Visibility
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Password Strength Checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        
        if (!password) {
            strengthFill.className = 'strength-fill';
            strengthText.className = 'strength-text small mt-1';
            strengthText.textContent = 'Entrez un mot de passe';
            return;
        }
        
        // Length check
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // Character variety checks
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z\d]/.test(password)) strength++;
        
        // Update UI based on strength
        strengthFill.className = 'strength-fill';
        strengthText.className = 'strength-text small mt-1';
        
        if (strength <= 1) {
            strengthFill.classList.add('weak');
            strengthText.classList.add('weak');
            strengthText.textContent = 'Faible - Ajoutez plus de caractères';
        } else if (strength <= 2) {
            strengthFill.classList.add('fair');
            strengthText.classList.add('fair');
            strengthText.textContent = 'Moyen - Ajoutez des caractères spéciaux';
        } else if (strength <= 3) {
            strengthFill.classList.add('good');
            strengthText.classList.add('good');
            strengthText.textContent = 'Bon - Presque parfait';
        } else {
            strengthFill.classList.add('strong');
            strengthText.classList.add('strong');
            strengthText.textContent = 'Excellent - Mot de passe sécurisé';
        }
    }

    // Password input listener
    document.getElementById('floatingPassword1').addEventListener('input', function(e) {
        checkPasswordStrength(e.target.value);
    });

    // Password match validation
    document.getElementById('floatingPassword2').addEventListener('input', function(e) {
        const password1 = document.getElementById('floatingPassword1').value;
        const password2 = e.target.value;
        
        if (password2 && password1 !== password2) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });

    // Form Submit Handler
    document.getElementById('kt_sign_up_form').addEventListener('submit', function(e) {
        const btn = document.getElementById('kt_sign_up_submit');
        const label = btn.querySelector('.indicator-label');
        const progress = btn.querySelector('.indicator-progress');
        const termsCheck = document.getElementById('termsCheck');
        
        if (!termsCheck.checked) {
            e.preventDefault();
            alert('Veuillez accepter les conditions d\'utilisation');
            return;
        }
        
        if (btn && label && progress) {
            btn.setAttribute('disabled', 'disabled');
            label.classList.add('d-none');
            progress.classList.remove('d-none');
        }
    });

    // Input Focus Animation
    document.querySelectorAll('.form-modern').forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.01)';
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
        });
    });
</script>
{% endblock %}

{% block content %}{% endblock %}
